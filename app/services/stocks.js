import Ember from 'ember';
import RSVP from 'rsvp';
import ENV from 'stock-report/config/environment';

const $   = Ember.$;
const api = ENV.alphavantage;

const example = {
  "Meta Data":           {
    "1. Information":    "Daily Prices (open, high, low, close) and Volumes",
    "2. Symbol":         "GOOG",
    "3. Last Refreshed": "2017-12-22",
    "4. Output Size":    "Compact",
    "5. Time Zone":      "US/Eastern"
  },
  "Time Series (Daily)": {
    "2017-12-22": {
      "1. open":   "1061.1100",
      "2. high":   "1064.2000",
      "3. low":    "1059.4400",
      "4. close":  "1060.1200",
      "5. volume": "755087"
    },
    "2017-12-21": {
      "1. open":   "1064.9500",
      "2. high":   "1069.3300",
      "3. low":    "1061.7900",
      "4. close":  "1063.6300",
      "5. volume": "974594"
    },
    "2017-12-20": {
      "1. open":   "1071.7800",
      "2. high":   "1073.3800",
      "3. low":    "1061.5200",
      "4. close":  "1064.9500",
      "5. volume": "1266115"
    },
    "2017-12-19": {
      "1. open":   "1075.2000",
      "2. high":   "1076.8400",
      "3. low":    "1063.5500",
      "4. close":  "1070.6800",
      "5. volume": "1254615"
    },
    "2017-12-18": {
      "1. open":   "1066.0800",
      "2. high":   "1078.4900",
      "3. low":    "1062.0000",
      "4. close":  "1077.1400",
      "5. volume": "1531522"
    },
    "2017-12-15": {
      "1. open":   "1054.6100",
      "2. high":   "1067.6200",
      "3. low":    "1049.5000",
      "4. close":  "1064.1900",
      "5. volume": "3142760"
    },
    "2017-12-14": {
      "1. open":   "1045.0000",
      "2. high":   "1058.5000",
      "3. low":    "1043.1100",
      "4. close":  "1049.1500",
      "5. volume": "1545616"
    },
    "2017-12-13": {
      "1. open":   "1046.1200",
      "2. high":   "1046.6600",
      "3. low":    "1038.3800",
      "4. close":  "1040.6100",
      "5. volume": "1207286"
    },
    "2017-12-12": {
      "1. open":   "1039.6300",
      "2. high":   "1050.3100",
      "3. low":    "1033.6900",
      "4. close":  "1040.4800",
      "5. volume": "1269883"
    },
    "2017-12-11": {
      "1. open":   "1035.5000",
      "2. high":   "1043.8000",
      "3. low":    "1032.0500",
      "4. close":  "1041.1000",
      "5. volume": "1119052"
    },
    "2017-12-08": {
      "1. open":   "1037.4900",
      "2. high":   "1042.0500",
      "3. low":    "1032.5200",
      "4. close":  "1037.0500",
      "5. volume": "1277894"
    },
    "2017-12-07": {
      "1. open":   "1020.4300",
      "2. high":   "1034.2400",
      "3. low":    "1018.0700",
      "4. close":  "1030.9300",
      "5. volume": "1387107"
    },
    "2017-12-06": {
      "1. open":   "1001.5000",
      "2. high":   "1024.9700",
      "3. low":    "1001.1400",
      "4. close":  "1018.3800",
      "5. volume": "1254837"
    },
    "2017-12-05": {
      "1. open":   "995.9400",
      "2. high":   "1020.6100",
      "3. low":    "988.2800",
      "4. close":  "1005.1500",
      "5. volume": "2023376"
    },
    "2017-12-04": {
      "1. open":   "1012.6600",
      "2. high":   "1016.1000",
      "3. low":    "995.5700",
      "4. close":  "998.6800",
      "5. volume": "1891408"
    },
    "2017-12-01": {
      "1. open":   "1015.8000",
      "2. high":   "1022.4900",
      "3. low":    "1002.0200",
      "4. close":  "1010.1700",
      "5. volume": "1908944"
    },
    "2017-11-30": {
      "1. open":   "1022.3700",
      "2. high":   "1028.4900",
      "3. low":    "1015.0000",
      "4. close":  "1021.4100",
      "5. volume": "1722913"
    },
    "2017-11-29": {
      "1. open":   "1042.6800",
      "2. high":   "1044.0800",
      "3. low":    "1015.6500",
      "4. close":  "1021.6600",
      "5. volume": "2438875"
    },
    "2017-11-28": {
      "1. open":   "1055.0900",
      "2. high":   "1062.3800",
      "3. low":    "1040.0000",
      "4. close":  "1047.4100",
      "5. volume": "1341000"
    },
    "2017-11-27": {
      "1. open":   "1040.0000",
      "2. high":   "1055.4600",
      "3. low":    "1038.4400",
      "4. close":  "1054.2100",
      "5. volume": "1284354"
    },
    "2017-11-24": {
      "1. open":   "1035.8700",
      "2. high":   "1043.1800",
      "3. low":    "1035.0000",
      "4. close":  "1040.6100",
      "5. volume": "536958"
    },
    "2017-11-22": {
      "1. open":   "1035.0000",
      "2. high":   "1039.7060",
      "3. low":    "1031.4300",
      "4. close":  "1035.9600",
      "5. volume": "716661"
    },
    "2017-11-21": {
      "1. open":   "1023.3100",
      "2. high":   "1035.1100",
      "3. low":    "1022.6550",
      "4. close":  "1034.4900",
      "5. volume": "1083715"
    },
    "2017-11-20": {
      "1. open":   "1020.2600",
      "2. high":   "1022.6100",
      "3. low":    "1017.5000",
      "4. close":  "1018.3800",
      "5. volume": "894844"
    },
    "2017-11-17": {
      "1. open":   "1034.0100",
      "2. high":   "1034.4200",
      "3. low":    "1017.7500",
      "4. close":  "1019.0900",
      "5. volume": "1350144"
    },
    "2017-11-16": {
      "1. open":   "1022.5200",
      "2. high":   "1035.9200",
      "3. low":    "1022.5200",
      "4. close":  "1032.5000",
      "5. volume": "1129423"
    },
    "2017-11-15": {
      "1. open":   "1019.2100",
      "2. high":   "1024.0900",
      "3. low":    "1015.4200",
      "4. close":  "1020.9100",
      "5. volume": "859951"
    },
    "2017-11-14": {
      "1. open":   "1022.5900",
      "2. high":   "1026.8100",
      "3. low":    "1014.1500",
      "4. close":  "1026.0000",
      "5. volume": "947273"
    },
    "2017-11-13": {
      "1. open":   "1023.4200",
      "2. high":   "1031.5800",
      "3. low":    "1022.5700",
      "4. close":  "1025.7500",
      "5. volume": "878969"
    },
    "2017-11-10": {
      "1. open":   "1026.4600",
      "2. high":   "1030.7600",
      "3. low":    "1025.2800",
      "4. close":  "1028.0700",
      "5. volume": "719227"
    },
    "2017-11-09": {
      "1. open":   "1033.9900",
      "2. high":   "1033.9900",
      "3. low":    "1019.6660",
      "4. close":  "1031.2600",
      "5. volume": "1236903"
    },
    "2017-11-08": {
      "1. open":   "1030.5200",
      "2. high":   "1043.5220",
      "3. low":    "1028.4500",
      "4. close":  "1039.8500",
      "5. volume": "1088716"
    },
    "2017-11-07": {
      "1. open":   "1027.2700",
      "2. high":   "1033.9700",
      "3. low":    "1025.1300",
      "4. close":  "1033.3300",
      "5. volume": "1089887"
    },
    "2017-11-06": {
      "1. open":   "1028.9900",
      "2. high":   "1034.8700",
      "3. low":    "1025.0000",
      "4. close":  "1025.9000",
      "5. volume": "1119131"
    },
    "2017-11-03": {
      "1. open":   "1022.1100",
      "2. high":   "1032.6500",
      "3. low":    "1020.3100",
      "4. close":  "1032.4800",
      "5. volume": "1058037"
    },
    "2017-11-02": {
      "1. open":   "1021.7600",
      "2. high":   "1028.0900",
      "3. low":    "1013.0100",
      "4. close":  "1025.5800",
      "5. volume": "1008190"
    },
    "2017-11-01": {
      "1. open":   "1017.2100",
      "2. high":   "1029.6700",
      "3. low":    "1016.9500",
      "4. close":  "1025.5000",
      "5. volume": "1360900"
    },
    "2017-10-31": {
      "1. open":   "1015.2200",
      "2. high":   "1024.0000",
      "3. low":    "1010.4200",
      "4. close":  "1016.6400",
      "5. volume": "1324961"
    },
    "2017-10-30": {
      "1. open":   "1014.0000",
      "2. high":   "1024.9700",
      "3. low":    "1007.5000",
      "4. close":  "1017.1100",
      "5. volume": "2074619"
    },
    "2017-10-27": {
      "1. open":   "1009.1900",
      "2. high":   "1048.3900",
      "3. low":    "1008.2000",
      "4. close":  "1019.2700",
      "5. volume": "5125791"
    },
    "2017-10-26": {
      "1. open":   "980.0000",
      "2. high":   "987.6000",
      "3. low":    "972.2000",
      "4. close":  "972.5600",
      "5. volume": "1660850"
    },
    "2017-10-25": {
      "1. open":   "968.3700",
      "2. high":   "976.0900",
      "3. low":    "960.5200",
      "4. close":  "973.3300",
      "5. volume": "1162606"
    },
    "2017-10-24": {
      "1. open":   "970.0000",
      "2. high":   "972.2300",
      "3. low":    "961.0000",
      "4. close":  "970.5400",
      "5. volume": "1155231"
    },
    "2017-10-23": {
      "1. open":   "989.5200",
      "2. high":   "989.5200",
      "3. low":    "966.1200",
      "4. close":  "968.4500",
      "5. volume": "1431886"
    },
    "2017-10-20": {
      "1. open":   "989.4400",
      "2. high":   "991.0000",
      "3. low":    "984.5800",
      "4. close":  "988.2000",
      "5. volume": "1120038"
    },
    "2017-10-19": {
      "1. open":   "986.0000",
      "2. high":   "988.8800",
      "3. low":    "978.3900",
      "4. close":  "984.4500",
      "5. volume": "1282755"
    },
    "2017-10-18": {
      "1. open":   "991.7700",
      "2. high":   "996.7200",
      "3. low":    "986.9750",
      "4. close":  "992.8100",
      "5. volume": "1022521"
    },
    "2017-10-17": {
      "1. open":   "990.2900",
      "2. high":   "996.4400",
      "3. low":    "988.5900",
      "4. close":  "992.1800",
      "5. volume": "1266399"
    },
    "2017-10-16": {
      "1. open":   "992.1000",
      "2. high":   "993.9070",
      "3. low":    "984.0000",
      "4. close":  "992.0000",
      "5. volume": "900751"
    },
    "2017-10-13": {
      "1. open":   "992.0000",
      "2. high":   "997.2100",
      "3. low":    "989.0000",
      "4. close":  "989.6800",
      "5. volume": "1143907"
    },
    "2017-10-12": {
      "1. open":   "987.4500",
      "2. high":   "994.1200",
      "3. low":    "985.0000",
      "4. close":  "987.8300",
      "5. volume": "1259082"
    },
    "2017-10-11": {
      "1. open":   "973.7200",
      "2. high":   "990.7100",
      "3. low":    "972.2500",
      "4. close":  "989.2500",
      "5. volume": "1663731"
    },
    "2017-10-10": {
      "1. open":   "980.0000",
      "2. high":   "981.5700",
      "3. low":    "966.0800",
      "4. close":  "972.6000",
      "5. volume": "956419"
    },
    "2017-10-09": {
      "1. open":   "980.0000",
      "2. high":   "985.4250",
      "3. low":    "976.1100",
      "4. close":  "977.0000",
      "5. volume": "886700"
    },
    "2017-10-06": {
      "1. open":   "966.7000",
      "2. high":   "979.4600",
      "3. low":    "963.3600",
      "4. close":  "978.8900",
      "5. volume": "1142699"
    },
    "2017-10-05": {
      "1. open":   "955.4900",
      "2. high":   "970.9100",
      "3. low":    "955.1800",
      "4. close":  "969.9600",
      "5. volume": "1202101"
    },
    "2017-10-04": {
      "1. open":   "957.0000",
      "2. high":   "960.3900",
      "3. low":    "950.6900",
      "4. close":  "951.6800",
      "5. volume": "881380"
    },
    "2017-10-03": {
      "1. open":   "954.0000",
      "2. high":   "958.0000",
      "3. low":    "949.1400",
      "4. close":  "957.7900",
      "5. volume": "881562"
    },
    "2017-10-02": {
      "1. open":   "959.9800",
      "2. high":   "962.5400",
      "3. low":    "947.8400",
      "4. close":  "953.2700",
      "5. volume": "1222026"
    },
    "2017-09-29": {
      "1. open":   "952.0000",
      "2. high":   "959.7860",
      "3. low":    "951.5100",
      "4. close":  "959.1100",
      "5. volume": "1533133"
    },
    "2017-09-28": {
      "1. open":   "941.3600",
      "2. high":   "950.6900",
      "3. low":    "940.5500",
      "4. close":  "949.5000",
      "5. volume": "959648"
    },
    "2017-09-27": {
      "1. open":   "927.7400",
      "2. high":   "949.9000",
      "3. low":    "927.7400",
      "4. close":  "944.4900",
      "5. volume": "2202959"
    },
    "2017-09-26": {
      "1. open":   "923.7200",
      "2. high":   "930.8200",
      "3. low":    "921.1400",
      "4. close":  "924.8600",
      "5. volume": "1652848"
    },
    "2017-09-25": {
      "1. open":   "925.4500",
      "2. high":   "926.4000",
      "3. low":    "909.7000",
      "4. close":  "920.9700",
      "5. volume": "1822881"
    },
    "2017-09-22": {
      "1. open":   "927.7500",
      "2. high":   "934.7300",
      "3. low":    "926.4800",
      "4. close":  "928.5300",
      "5. volume": "1038551"
    },
    "2017-09-21": {
      "1. open":   "933.0000",
      "2. high":   "936.5300",
      "3. low":    "923.8300",
      "4. close":  "932.4500",
      "5. volume": "1207656"
    },
    "2017-09-20": {
      "1. open":   "922.9800",
      "2. high":   "933.8800",
      "3. low":    "922.0000",
      "4. close":  "931.5800",
      "5. volume": "1518166"
    },
    "2017-09-19": {
      "1. open":   "917.4200",
      "2. high":   "922.4200",
      "3. low":    "912.5500",
      "4. close":  "921.8100",
      "5. volume": "902415"
    },
    "2017-09-18": {
      "1. open":   "920.0100",
      "2. high":   "922.0800",
      "3. low":    "910.6000",
      "4. close":  "915.0000",
      "5. volume": "1263456"
    },
    "2017-09-15": {
      "1. open":   "924.6600",
      "2. high":   "926.4900",
      "3. low":    "916.3600",
      "4. close":  "920.2900",
      "5. volume": "2475031"
    },
    "2017-09-14": {
      "1. open":   "931.2500",
      "2. high":   "932.7700",
      "3. low":    "924.0000",
      "4. close":  "925.1100",
      "5. volume": "1389012"
    },
    "2017-09-13": {
      "1. open":   "930.6600",
      "2. high":   "937.2500",
      "3. low":    "929.8600",
      "4. close":  "935.0900",
      "5. volume": "1066051"
    },
    "2017-09-12": {
      "1. open":   "932.5900",
      "2. high":   "933.4800",
      "3. low":    "923.8610",
      "4. close":  "932.0700",
      "5. volume": "1120449"
    },
    "2017-09-11": {
      "1. open":   "934.2500",
      "2. high":   "938.3800",
      "3. low":    "926.9200",
      "4. close":  "929.0800",
      "5. volume": "1247138"
    },
    "2017-09-08": {
      "1. open":   "936.4900",
      "2. high":   "936.9900",
      "3. low":    "924.8800",
      "4. close":  "926.5000",
      "5. volume": "993832"
    },
    "2017-09-07": {
      "1. open":   "931.7300",
      "2. high":   "936.4100",
      "3. low":    "923.6200",
      "4. close":  "935.9500",
      "5. volume": "1200257"
    },
    "2017-09-06": {
      "1. open":   "930.1500",
      "2. high":   "930.9150",
      "3. low":    "919.2700",
      "4. close":  "927.8100",
      "5. volume": "1468808"
    },
    "2017-09-05": {
      "1. open":   "933.0800",
      "2. high":   "937.0000",
      "3. low":    "921.9600",
      "4. close":  "928.4500",
      "5. volume": "1202163"
    },
    "2017-09-01": {
      "1. open":   "941.1300",
      "2. high":   "942.4800",
      "3. low":    "935.1500",
      "4. close":  "937.3400",
      "5. volume": "913404"
    },
    "2017-08-31": {
      "1. open":   "931.7600",
      "2. high":   "941.9800",
      "3. low":    "931.7600",
      "4. close":  "939.3300",
      "5. volume": "1553301"
    },
    "2017-08-30": {
      "1. open":   "920.0500",
      "2. high":   "930.8190",
      "3. low":    "919.6500",
      "4. close":  "929.5700",
      "5. volume": "1282093"
    },
    "2017-08-29": {
      "1. open":   "905.1000",
      "2. high":   "923.3300",
      "3. low":    "905.0000",
      "4. close":  "921.2900",
      "5. volume": "1180160"
    },
    "2017-08-28": {
      "1. open":   "916.0000",
      "2. high":   "919.2450",
      "3. low":    "911.8700",
      "4. close":  "913.8100",
      "5. volume": "1072467"
    },
    "2017-08-25": {
      "1. open":   "923.4900",
      "2. high":   "925.5550",
      "3. low":    "915.5000",
      "4. close":  "915.8900",
      "5. volume": "1040693"
    },
    "2017-08-24": {
      "1. open":   "928.6600",
      "2. high":   "930.8400",
      "3. low":    "915.5000",
      "4. close":  "921.2800",
      "5. volume": "1218875"
    },
    "2017-08-23": {
      "1. open":   "921.9300",
      "2. high":   "929.9300",
      "3. low":    "919.3600",
      "4. close":  "927.0000",
      "5. volume": "1077809"
    },
    "2017-08-22": {
      "1. open":   "912.7200",
      "2. high":   "925.8600",
      "3. low":    "911.4750",
      "4. close":  "924.6900",
      "5. volume": "1145571"
    },
    "2017-08-21": {
      "1. open":   "910.0000",
      "2. high":   "913.0000",
      "3. low":    "903.4000",
      "4. close":  "906.6600",
      "5. volume": "932903"
    },
    "2017-08-18": {
      "1. open":   "910.3100",
      "2. high":   "915.2750",
      "3. low":    "907.1540",
      "4. close":  "910.6700",
      "5. volume": "1333572"
    },
    "2017-08-17": {
      "1. open":   "925.7800",
      "2. high":   "926.8600",
      "3. low":    "910.9800",
      "4. close":  "910.9800",
      "5. volume": "1218963"
    },
    "2017-08-16": {
      "1. open":   "925.2900",
      "2. high":   "932.7000",
      "3. low":    "923.4450",
      "4. close":  "926.9600",
      "5. volume": "988604"
    },
    "2017-08-15": {
      "1. open":   "924.2300",
      "2. high":   "926.5500",
      "3. low":    "919.8200",
      "4. close":  "922.2200",
      "5. volume": "873070"
    },
    "2017-08-14": {
      "1. open":   "922.5300",
      "2. high":   "924.6680",
      "3. low":    "918.1900",
      "4. close":  "922.6700",
      "5. volume": "1047828"
    },
    "2017-08-11": {
      "1. open":   "907.9700",
      "2. high":   "917.7800",
      "3. low":    "905.5800",
      "4. close":  "914.3900",
      "5. volume": "1190458"
    },
    "2017-08-10": {
      "1. open":   "917.5500",
      "2. high":   "919.2600",
      "3. low":    "906.1300",
      "4. close":  "907.2400",
      "5. volume": "1722296"
    },
    "2017-08-09": {
      "1. open":   "920.6100",
      "2. high":   "925.9800",
      "3. low":    "917.2500",
      "4. close":  "922.9000",
      "5. volume": "1169431"
    },
    "2017-08-08": {
      "1. open":   "927.0900",
      "2. high":   "935.8140",
      "3. low":    "925.6100",
      "4. close":  "926.7900",
      "5. volume": "1039394"
    },
    "2017-08-07": {
      "1. open":   "929.0600",
      "2. high":   "931.7000",
      "3. low":    "926.5000",
      "4. close":  "929.3600",
      "5. volume": "1012296"
    },
    "2017-08-04": {
      "1. open":   "926.7500",
      "2. high":   "930.3070",
      "3. low":    "923.0300",
      "4. close":  "927.9600",
      "5. volume": "1019159"
    },
    "2017-08-03": {
      "1. open":   "930.3400",
      "2. high":   "932.2400",
      "3. low":    "922.2400",
      "4. close":  "923.6500",
      "5. volume": "1179126"
    }
  }
};

export default Ember.Service.extend({
  store: Ember.inject.service('store'),

  getSymbol (symbol, options) {
      // debugger
    if (!symbol) {
      return null;
    } else if (Array.isArray(symbol) || (symbol.content && Array.isArray(symbol.content))) {
      return RSVP.all(symbol.map(s => this.getSymbol(s, options)));
    }

    const store = this.get('store');
    const query = Object.assign({}, api.defaults, {apikey: api.key, symbol}, options);

    return $.getJSON(api.baseUrl, query)
      .then(data => {

        let {'Meta Data': meta, 'Time Series (Daily)': days} = data;

        let stock = store.createRecord('stock', {
          id: symbol,
          symbol,
          lastUpdated: new Date(meta['3. Last Refreshed']),
          timeZone:    meta['5. Time Zone'],
        });

        days = Object.getOwnPropertyNames(days)
          .map(date => {
            let data = days[date];
            return store.createRecord('day', {
              date:        new Date(date),
              open:        Number(data['1. open']),
              low:         Number(data['2. high']),
              high:        Number(data['3. low']),
              close:       Number(data['4. close']),
              volume:      Number(data['5. volume']),

              stock
            });
          })
        ;

        stock.set('days', days);

        return stock;
      })
      .catch((resp, textStatus, error) => {
        return error;
      })
      ;
  }
});
